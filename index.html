<!DOCTYPE html>
<html>
<head>
<meta id="meta" name="viewport" content="width=device-width; user-scalable=no; initial-scale=1.0" />
<meta charset=utf-8 />
<title>MarblesÂ²</title>
<link href='marbles-squared.png' rel='apple-touch-icon' />
<link href='marbles-squared.png' rel='icon' type="image/png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta names="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link href='Default.png' rel='apple-touch-startup-image' />
<link rel="stylesheet" href="master.css" type="text/css" />
</head>
<body class="loading">
<div id="loading"></div>
<div class="toolbar" id="toolbar">
  <div class="button" id="highscore"><img src="images/highscore.png" /><span id="hsn"></span></div>
  <div class="button" id="start">New Game</div>
</div>
<div selected="true" id="grid"></div>
<div id="levelup">
  <p>Congratulations!</p>
  <p>Starting new board in<span id="newGameCountdown">3</span></p>
</div>
<div id="replay">
  <p id="msg">You lose!</p>
  <a id="retryboard" href="#">Retry board</a>
  <a id="tweet" href="#">Tweet!</a>
</div>
<div id="status" class="toolbar">
  <span id="score">Score: 0</span>
  <span id="potential">Level: 1</span>
</div>
<div id="saveToSpring"></div>
<div id="timer" class="toolbar"></div>
<div id="highscores">
  <h1>High Scores</h1>
  <div>
    <table>
      <thead>
        <tr>
          <th class="position">#</th>
          <th class="score">score</th>
          <th class="when">when</th>
        </tr>
      </thead>
      <tbody id="highscoreTable"></tbody></table>
  </div>
</div>
<script src="xui-core-1.0.0.min.js"></script>
<script src="xui-anim.js"></script>
<script src="xui-plugins.js"></script>
<script src="phonegap.js"></script>
<script src="storage.js"></script>
<script src="marbles.js"></script>
<script>
// poor man's JSON parser - we're only using it for private data
// (function () {
var $ = xui, 
    bonusTimer, 
    levelUpTimer = null,
    $potential = $('#potential'),
    gameActive = false,
    colours = ['empty', 'one', 'two', 'three', 'four'],
    $grid = $('#grid'),
    n = 7, 
    // dimension information - 7x7 grid, 3 types
    nativeapp = (window.innerHeight == 460 && !navigator.standalone) ? 1 : false, // this sucks, but it's the only way to work it out
    comp = window.getComputedStyle(document.body,null),
    bodyDims = { height: parseInt(comp['height']) - (nativeapp ? 20 : 0), width: parseInt(comp['width']) },
    whichBaseLine = bodyDims.width > bodyDims.height ? 'height' : 'width',
    controlHeight = bodyDims.height - bodyDims.width < 90 ? 90 : 0, // 90 = 44 * 2 + 2px border 
    baseWidth = (bodyDims.width > bodyDims.height ? bodyDims.height : bodyDims.width) - controlHeight,
    // baseWidth = 320,
    dim = { grid: [n,n], types: 3, marble: [~~(baseWidth/n),~~(baseWidth/n)] },
    $score = $('#score'),
    $start = $('#start'),
    $retryboard = $('#retryboard'),
    // $playagain = $('#playagain'),
    $marbles,
    highscores = JSON.parse(localStorage.getItem('highscores') || '[]') || [],
    playedBefore = localStorage ? localStorage.getItem('playedBefore') : null,
    lose = [
      'You lose.',
      'Try harder.',
      'Game. Over.',
      'You lost. Again.',
      'Try again?',
      'More effort required',
      'Are you even trying?',
      'Shall we start again?'
    ],
    $body = $(document.body),
    $tweet = $('#tweet');


var s = document.createElement('style');
s.innerText = '#grid > div { height: ' + (~~(baseWidth/7)-5) + 'px; width: ' + (~~(baseWidth/7)-5) + 'px; } #grid { height: ' + baseWidth + 'px; left: ' + Math.ceil((bodyDims.width - (~~(baseWidth/n))*7)/2) + 'px; ; } html,body { height: ' + bodyDims.height + 'px;}';
document.body.appendChild(s);

Marbles.drawMarble = function (x, y, tagged, type) {
  var i = x + (Marbles.width * y);
  $marbles[x + (Marbles.width * y)].className = colours[type] || 'empty';
  if (tagged) $marbles[i].className += ' selected';
};

Marbles.gameover(function () {
  var movesLeft = this.movesLeft(), msg = '';
  
  stopTimer();
  
  if (movesLeft === 0 && this.marblesLeft() !== 0) {
    gameActive = false;
    msg = saveHighscore();
    $('#msg').html(msg);
    $body.addClass('gameover');
    serverLog(JSON.stringify(Marbles.history));
  } else if (movesLeft === 0 && this.marblesLeft() === 0) {
    // next level
    this.levelUp();
    $body.addClass('levelup');
    levelUpTimer = setInterval(function () {
      var countdown = $('#newGameCountdown')[0];
      if (countdown.innerHTML == 0) {
        clearInterval(levelUpTimer);
        initDraw();
      } else {
        countdown.innerHTML = countdown.innerHTML - 1;
      }
    }, 1000);
  }
});

function initDraw(noTimer) {
  clearInterval(levelUpTimer); // just in case
  $body.removeClass('levelup');
  var countdown = $('#newGameCountdown')[0];
  countdown.innerHTML = '3';
  $potential.html('Level: ' + Marbles.level);
  Marbles.init(dim.grid[0], dim.grid[1], dim.types);
  
  // var divs = $grid[0].getElementsByTagName('div');
  // [].forEach.call(divs, function (div) {
  //   div.parentNode.removeChild(div);
  // });
  $grid.find('div').each(function () {
    this.parentNode.removeChild(this);
  });
  
  $body.removeClass('gameover');  
  
  // rebuild
  var h = parseInt(Marbles.height * dim.marble[1]), w = parseInt(Marbles.width * dim.marble[0]);
  $grid.css({ 'width': w, 'height': h });
  $('#grid').css('width', w);
  Marbles.loop(function (x,y) {
    var m = Marbles.get(x,y);
    var d = document.createElement('div');
    d.x = x;
    d.y = y;
    d.className = colours[m.type]; // should never be tagged during this point
    $grid[0].appendChild(d);
    $(d).css({ 
      'background': colours[m.tagged] || 'empty', 
      'left': parseInt(x * dim.marble[0]) + 'px',
      'top': parseInt(h - dim.marble[1] - (y * dim.marble[1])) + 'px'
    });
  });
  $marbles = $grid.find('div'); //$($grid[0].getElementsByTagName('div'));
  $marbles.touch(selectMarble);
  gameActive = true;
  $score.html('Score: ' + commafy(Marbles.getScore()));
  
  if (noTimer != true) startTimer();
  
  return false;
}

function newTimer(width) {
  var countdown = $('#timer')[0], newCountdown = document.createElement('div');
  newCountdown.setAttribute('id', 'timer');
  if (width) newCountdown.style.width = width;
  // newCountdown.innerHTML = '<span>Bonus</span>';
  newCountdown.className = 'toolbar';
  
  document.body.appendChild(newCountdown);
  countdown.parentNode.removeChild(countdown);  
}

function startTimer() {
  // reset
  newTimer();  
  $('#timer').tween({ width : 0 + 'px' }, { duration: 10 * 1000, easing: 'linear', callback: function () {
    Marbles.bonusFinished();
  }});
}

function stopTimer() {
  newTimer(getComputedStyle(document.getElementById('timer'), null).width);
}

function prevent(event) {
  event && event.preventDefault && event.preventDefault();
  event && event.stopPropagation && event.stopPropagation();  
}

function selectMarble(event) {
  prevent(event);
  
  if (!gameActive) return;

  var t = this, //event.target, 
      m = Marbles.get(t.x, t.y);

  if (m) { 
    m.tag();
    if (Marbles.activeTags) {
      Marbles.clear();      
    }
  }

  $score.html('Score: ' + commafy(Marbles.getScore()));
}

// broken in PhoneGap 0.8.3
// var wide = document.createElement('meta');
// wide.setAttribute('id','meta');
// wide.setAttribute('name', 'viewport');
// wide.setAttribute('content', 'width=720; user-scalable=no');
// 
// var narrow = document.createElement('meta');
// narrow.setAttribute('id','meta');
// narrow.setAttribute('name', 'viewport');
// narrow.setAttribute('content', 'width=320; user-scalable=no');

$(document).on('orientationchange', function(e) { 
  // alert("Orientation changed to " + window.orientation); 
  // var meta = document.getElementById('meta');
  // meta.parentNode.removeChild(meta);
  // document.getElementsByTagName('head')[0].appendChild(window.orientation === 0 ? narrow : wide);
  setTimeout(function () {
    window.scrollTo(0, 1);
  }, 10);
  
  // <meta name="viewport" content="width=720; user-scalable=no" />
}, false);

// play again
function newGame(event) {
  prevent(event);
  Marbles.newGame();
  return initDraw();
}

function retryboard(e) {
  prevent(event);
  Marbles.seed(Marbles.seed());
  Marbles.newGame();
  return initDraw();
}

function levelUpNewGame(event) {
  prevent(event)
  clearInterval(levelUpTimer);
  $body.removeClass('levelup');
  $('#newGameCountdown')[0].innerHTML = '3';
  initDraw();
}

function removeSave(event) {
  document.body.className = '';
  startTimer();
  event && event.preventDefault && event.preventDefault();
}

function saveHighscore() {
  var score = Marbles.getScore(), oldhighscore = highscores.length ? highscores[0].score : 0;
  highscores.push({ score: score, date: +new Date(), level: Marbles.level, seed: Marbles.seed() });
  highscores = highscores.sort(function (a, b) {
    return b.score > a.score ? 1 : -1;
  }).slice(0, 10); // limit to 10;
  
  try {
    // annoying that Safari occassionally breaks here for no reason
    localStorage.setItem('highscores', JSON.stringify(highscores));    
  } catch (e) {}
  
  if (oldhighscore < score) {
    // genius: http://twitter.com/slevithan/status/11418431475
    $('#hsn')[0].innerHTML = commafy(score);
    
    return "Yay! High score!";
  } else {
    return lose[~~(Math.random()*lose.length)];
  }
}

function commafy(n) {
  return n.toString().replace(/(^|[^\w.])(\d{4,})/g, function($0,$1,$2) {
    return $1 + $2.replace(/\d(?=(?:\d\d\d)+(?!\d))/g, "$&,");
  });
}

function showHighscores(event) {
  prevent(event);
  var el = $('#highscoreTable')[0];
  el.innerHTML = '';
  highscores.forEach(function (score, i) {
    el.innerHTML += '<tr><td>' + time.relative(score.date) +'</td><td>' + commafy(score.score) + '</td><td>' + (score.seed ? '<div class="playagain button" data-seed="' + score.seed + '">Play</div>' : '&nbsp;') + '</td></tr>';
  });
  
  $body.addClass('highscores');
}

function openURL(url, def) {
  var iframe = document.createElement('iframe');
  iframe.style.visibility = 'none';
  iframe.style.position = 'absolute';
  iframe.style.left = '-999px';
  iframe.style.height = '1px';
  iframe.style.width = '1px';
  
  document.body.appendChild(iframe);
  
  if (!nativeapp) {
    window.location = def;
    return;
  }
  
  var sandbox = iframe.contentWindow;
  try {
    var ok = iframe.contentWindow.eval('location = "' + url + '";');
  } catch (e) {
    window.location = def;
  }
}

function serverLog(message) {
  var client = new XMLHttpRequest();
  client.open("POST", "http://marbles2.com/log.php");
  client.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  client.send('data='+encodeURIComponent(message));
}

var time = function () {
  var monthDict = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return {
    time: function (date) {
      var hour = date.getHours(),
          min = date.getMinutes() + "",
          ampm = 'am';
  
      if (hour == 0) {
        hour = 12;
      } else if (hour == 12) {
        ampm = 'pm';
      } else if (hour > 12) {
        hour -= 12;
        ampm = 'pm';
      }
  
      if (min.length == 1) {
        min = '0' + min;
      }
  
      return hour + ampm;
    },
    date: function (date) {
      var ds = date.toDateString().split(/ /),
          mon = monthDict[date.getMonth()],
          day = date.getDate()+'',
          dayi = ~~(day),
          year = date.getFullYear(),
          thisyear = (new Date()).getFullYear(),
          th = 'th';

      // anti-'th' - but don't do the 11th, 12th or 13th
      if ((dayi % 10) == 1 && day.substr(0, 1) != '1') {
        th = 'st';
      } else if ((dayi % 10) == 2 && day.substr(0, 1) != '1') {
        th = 'nd';
      } else if ((dayi % 10) == 3 && day.substr(0, 1) != '1') {
        th = 'rd';
      }

      if (day.substr(0, 1) == '0') {
        day = day.substr(1);
      }

      return mon + ' ' + day + th + (thisyear != year ? ', ' + year : '');
    },
    datetime: function (t) {
      var date = new Date(t);

      return this.time(date) + ' ' + this.date(date);
    },
    relative: function (t) {
      var date = new Date(t),
          relative_to = (arguments.length > 1) ? arguments[1] : new Date(),
          delta = ~~((relative_to.getTime() - t) / 1000),
          r = '';

      // delta = delta + (relative_to.getTimezoneOffset() * 60);

      if (delta < 60) {
        r = 'just now';
      } else if (delta < 120) {
        r = 'a minute ago';
      } else if (delta < (45*60)) {
        r = (~~(delta / 60)).toString() + ' mins ago';
      } else if (delta < (2*90*60)) { // 2* because sometimes read 1 hours ago
        r = (~~(delta / 60)).toString() + ' mins ago';
        // r = '1 hour ago';
      } else if (delta < (24*60*60)) {
        r = (~~(delta / 3600)).toString() + ' hours ago';
      } else {
        if (delta < (48*60*60)) {
          r = this.time(date) + ' yesterday';
        } else {
          r = this.date(date); //  this.time(date) + ' ' + 
        }
      }

      return r;
    }    
  };
}();

$('#hsn').html(highscores.length ? commafy(highscores[0].score) : '');

// event hook up
$start.touch(newGame);
$tweet.touch(function () {
  var msg = "I just scored " + commafy(highscores[0].score) + " using this board: http://marbles2.com/app/?seed=" + Marbles.seed();
  openURL('tweetie:///post?message=' + encodeURIComponent(msg), 'http://twitter.com/?status=' + encodeURIComponent(msg));
});

// $playagain.touchClick(newGame);
$retryboard.touchClick(retryboard);
// $grid.touchClick(selectMarble);

$('#levelup').touchClick(levelUpNewGame);
$('#highscore').touch(showHighscores);

$('#highscores').touchClick(function (event) {
  prevent(event);
  $body.removeClass('highscores');
});

$body.on('touchmove', prevent);


// bit of magic: if the browser supports a custom url scheme, and the 
// custom scheme is supported, it'll redirect the browser window entirely.
// if it's not, it won't redirect, and the user will stil be able to play
// the game
window.location.search.replace(/\bseed=([^&=]*)\b/, function (m, seed) {
  var iframe = document.createElement('iframe');
  iframe.style.visibility = 'none';
  document.body.appendChild(iframe);
  iframe.onload = function () {
    document.body.removeChild(iframe);
  };
  iframe.contentWindow.location = 'marbles:///?seed=' + seed;
  Marbles.seed(seed); // handle the web based game using the seed
});

// horrible, but adds a tiny bit of nice ux
if (!nativeapp && /iphone/i.test(navigator.userAgent) && !navigator.standalone && !playedBefore ) {
  try {
    localStorage.setItem('playedBefore', true);    
  } catch (e) {}
  document.body.className = 'saveToSpring';
  $(document).touchClick(removeSave);
  initDraw(true);
} else {
  // Run!
  if (window.Invoke_params) {
    alert('using seed: ' + JSON.stringify(window.Invoke_params));
    Marbles.seed(window.Invoke_params.seed);
  }
  initDraw(true);
}

$(document).on('deviceready', function () {
  document.body.className = '';
  showHighscores();
  setTimeout(startTimer, 1000);
});

if (!PhoneGap.available) {
  $(document).fire('deviceready');
  // scroll the url bar out of view
  setTimeout(function () {
    window.scrollTo(0, 1);
  }, 10);
} 

// ui hook ups
// $('.button').button();
$('body').on('touchmove', function (e) {
  e.preventDefault();
});

// showHighscores();
// alert(document.URL);
// })();
</script>
</body>
</html>